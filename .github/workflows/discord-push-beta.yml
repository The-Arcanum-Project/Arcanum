# .github/workflows/discord-commit-webhook.yml

name: Discord Push Webhook

on:
  push:
    branches:
      - 1.0.4-Dev

jobs:
  send-to-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Build Commit Message and Count
        id: build_message
        run: |
          # split("Conflicts:")[0]  -> Takes everything BEFORE the list of conflicts
          # gsub("#"; "")           -> Removes all '#' characters to prevent Discord headers
          # sub("\\s+$"; "")        -> Trims the trailing whitespace left behind
          
          COMMIT_MESSAGES=$(echo '${{ toJSON(github.event.commits) }}' | jq -r '.[] | 
            (.message | split("Conflicts:")[0] | gsub("#"; "") | sub("\\s+$"; "")) as $msg | 
            "`" + .id[0:7] + "` - " + $msg + " - *" + .author.name + "*"'
          )
          
          # Set the message as a multi-line environment variable for the job.
          # The EOF heredoc syntax correctly preserves the newlines from the jq output.
          echo "message<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MESSAGES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Calculate the commit count using jq and save it as an environment variable
          echo "COMMIT_COUNT=$(echo '${{ toJSON(github.event.commits) }}' | jq 'length')" >> $GITHUB_ENV

      - name: Send Discord BETA Webhook
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_BETA_WEBHOOK_URL }}
          embed-title: "[${{ github.ref_name }}] ${{ env.COMMIT_COUNT }} new commit(s)"
          embed-description: "${{ env.message }}"
          embed-url: "${{ github.event.compare }}"
          embed-color: "3447003"
          embed-timestamp: "${{ github.event.head_commit.timestamp }}"
          embed-author-name: "${{ github.event.sender.login }}"
          embed-author-url: "${{ github.event.sender.html_url }}"
          embed-author-icon-url: "${{ github.event.sender.avatar_url }}"
