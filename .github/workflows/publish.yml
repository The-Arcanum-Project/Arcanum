name: Release Build

on:
  release:
    types: [published]

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write 

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x' 

    - name: Restore Dependencies
      run: dotnet restore
      
    # 2. Build Config 1: Framework Dependent:  Single File, ReadyToRun, NOT Self-Contained
    - name: Publish Framework Dependent
      run: |
        dotnet publish src/Arcanum.App/Arcanum.App.csproj `
          --configuration Release `
          --framework net10.0-windows `
          --runtime win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          --output ./publish/dependent

    # 3. Build Config 2: Self Contained: Single File, ReadyToRun, Self-Contained, Extract Options
    - name: Publish Self Contained
      run: |
        dotnet publish src/Arcanum.App/Arcanum.App.csproj `
          --configuration Release `
          --framework net10.0-windows `
          --runtime win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:IncludeAllContentForSelfExtract=true `
          --output ./publish/contained

    - name: Zip Framework Dependent
      run: Compress-Archive -Path ./publish/dependent/*.exe -DestinationPath ./Arcanum-FrameworkDependent.zip

    - name: Zip Self Contained
      run: Compress-Archive -Path ./publish/contained/*.exe -DestinationPath ./Arcanum-SelfContained.zip

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./Arcanum-FrameworkDependent.zip
          ./Arcanum-SelfContained.zip
          ./Arcanum-Source.zip
