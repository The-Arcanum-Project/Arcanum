<UserControl x:Class = "Arcanum.UI.Components.UserControls.ValueAllocators.IntValueAllocator"
             xmlns = "http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x = "http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc = "http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d = "http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local = "clr-namespace:Arcanum.UI.Components.UserControls.ValueAllocators"
             xmlns:converters = "clr-namespace:Arcanum.UI.Components.Converters"
             xmlns:styleClasses = "clr-namespace:Arcanum.UI.Components.StyleClasses" mc:Ignorable = "d"
             d:DesignHeight = "300" d:DesignWidth = "300" d:DataContext = "{d:DesignInstance local:AllocatorViewModel}">

    <UserControl.InputBindings>
        <!-- Alt+Z Undo -->
        <KeyBinding Modifiers = "Alt" Key = "Z" Command = "{Binding UndoCommand}" />
    </UserControl.InputBindings>

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source = "/Arcanum_UI;component/Components/Styles/Base/BaseTextBoxStyle.xaml" />
                <ResourceDictionary Source = "/Arcanum_UI;component/Components/Styles/Base/BaseButton.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Style for the Lock Button -->
            <Style x:Key = "LockToggleStyle" TargetType = "ToggleButton">
                <Setter Property = "Template">
                    <Setter.Value>
                        <ControlTemplate TargetType = "ToggleButton">
                            <Border Background = "Transparent" Padding = "2">
                                <ContentPresenter HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Setter Property = "Foreground" Value = "#AAA" />
                <Setter Property = "Content" Value = "🔓" />
                <Setter Property = "Cursor" Value = "Hand" />
                <Style.Triggers>
                    <Trigger Property = "IsChecked" Value = "True">
                        <Setter Property = "Content" Value = "🔒" /> <!-- Locked Icon -->
                    </Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key = "ThinBaseButtonStyle" TargetType = "styleClasses:BaseButton"
                   BasedOn = "{StaticResource {x:Type styleClasses:BaseButton}}">
                <Setter Property = "Background" Value = "Transparent" />
                <Setter Property = "BorderThickness" Value = "1" />
                <Setter Property = "FontWeight" Value = "Bold" />
                <Setter Property = "Cursor" Value = "Hand" />
                <Setter Property = "Width" Value = "20" />
            </Style>

            <Style x:Key = "BlueToggleButtonStyle" TargetType = "ToggleButton">
                <Setter Property = "Background" Value = "{StaticResource DefaultBackColorBrush}" />
                <Setter Property = "Foreground" Value = "{StaticResource DefaultForeColorBrush}" />
                <Setter Property = "BorderBrush" Value = "{StaticResource DefaultBorderColorBrush}" />
                <Setter Property = "BorderThickness" Value = "1" />
                <Setter Property = "Padding" Value = "2" />
                <Setter Property = "Cursor" Value = "Hand" />

                <!-- Overwrite the template for rounded corners -->
                <Setter Property = "Template">
                    <Setter.Value>
                        <ControlTemplate TargetType = "ToggleButton">
                            <Border x:Name = "border" Background = "{TemplateBinding Background}"
                                    BorderBrush = "{TemplateBinding BorderBrush}"
                                    BorderThickness = "{TemplateBinding BorderThickness}" CornerRadius = "3"
                                    Padding = "{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property = "IsMouseOver" Value = "True">
                                    <Setter TargetName = "border" Property = "Background"
                                            Value = "{StaticResource LightBackColorBrush}" />
                                </Trigger>
                                <Trigger Property = "IsPressed" Value = "True">
                                    <Setter TargetName = "border" Property = "Background"
                                            Value = "{StaticResource DarkerSelectedBackColorBrush}" />
                                </Trigger>
                                <Trigger Property = "IsChecked" Value = "True">
                                    <Setter TargetName = "border" Property = "Background"
                                            Value = "{StaticResource BlueAccentColorBrush}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>

                <Style.Triggers>
                    <Trigger Property = "IsChecked" Value = "False">
                        <Setter Property = "Foreground" Value = "{StaticResource BlueAccentColorBrush}" />
                    </Trigger>
                </Style.Triggers>
            </Style>

            <!-- Converter to calculate width based on distribution -->
            <converters:DistributionToWidthConverter x:Key = "DistributionToWidthConverter" />
            <converters:LimitToWidthConverter x:Key = "LimitToWidthConverter" />
            <converters:BorderClipConverter x:Key = "BorderClipConverter" />
        </ResourceDictionary>
    </UserControl.Resources>

    <Border BorderBrush = "#DDD" BorderThickness = "1" CornerRadius = "4" Padding = "10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height = "20" />
                <RowDefinition Height = "Auto" />
                <RowDefinition Height = "*" />
            </Grid.RowDefinitions>


            <Border x:Name = "OuterBorder" Grid.Row = "0" CornerRadius = "4" BorderThickness = "1"
                    BorderBrush = "{StaticResource DefaultBorderColorBrush}" Background = "Transparent"
                    VerticalAlignment = "Stretch" HorizontalAlignment = "Stretch">

                <ItemsControl Grid.Row = "0" x:Name = "CompositionBar" ItemsSource = "{Binding Items}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation = "Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.Clip>
                        <MultiBinding Converter = "{StaticResource BorderClipConverter}">
                            <Binding ElementName = "CompositionBar" Path = "ActualWidth" />
                            <Binding ElementName = "CompositionBar" Path = "ActualHeight" />
                            <Binding ElementName = "OuterBorder" Path = "CornerRadius" />
                        </MultiBinding>
                    </ItemsControl.Clip>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Height = "20" Background = "{Binding ColorBrush}" ToolTip = "{Binding Name}">
                                <Border.Width>
                                    <MultiBinding Converter = "{StaticResource DistributionToWidthConverter}">
                                        <Binding Path = "Value" />
                                        <Binding Path = "DataContext.TotalLimit"
                                                 RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                        <!-- Bind to the Container's Width -->
                                        <Binding ElementName = "CompositionBar" Path = "ActualWidth" />
                                    </MultiBinding>
                                </Border.Width>

                                <!-- Optional: Show Number inside bar if wide enough -->
                                <TextBlock Text = "{Binding Value}" Foreground = "White" FontSize = "10"
                                           FontWeight = "Bold" HorizontalAlignment = "Center"
                                           VerticalAlignment = "Center">
                                    <TextBlock.Style>
                                        <Style TargetType = "TextBlock">
                                            <Setter Property = "Visibility" Value = "Visible" />
                                            <Style.Triggers>
                                                <!-- Hide text if value is 0 -->
                                                <DataTrigger Binding = "{Binding Value}" Value = "0">
                                                    <Setter Property = "Visibility" Value = "Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>


            <!-- Header -->
            <Grid Grid.Row = "1" Margin = "0,4,0,15">
                <!-- Define columns to align Master Lock with Row Locks -->
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width = "30" /> <!-- Lock Column -->
                    <ColumnDefinition Width = "*" />
                </Grid.ColumnDefinitions>

                <!-- MASTER LOCK TOGGLE -->
                <ToggleButton Grid.Column = "0" Style = "{StaticResource LockToggleStyle}"
                              IsChecked = "{Binding AreAllLocked}" ToolTip = "Lock/Unlock All" />

                <!-- Total and Settings -->
                <Grid Grid.Column = "1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width = "Auto" />
                        <ColumnDefinition Width = "*" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column = "0" Orientation = "Horizontal" VerticalAlignment = "Center">
                        <TextBlock Text = "Total Limit:" FontWeight = "SemiBold" VerticalAlignment = "Center"
                                   Margin = "5,0,10,0" local:InteractionMonitor.AllocatorVM = "{Binding}" />
                        <styleClasses:CorneredTextBox Text = "{Binding TotalLimit, UpdateSourceTrigger=Explicit}"
                                                      local:TextBoxUtilities.UpdateDelay = "600" Width = "60"
                                                      Height = "24" VerticalContentAlignment = "Center"
                                                      HorizontalContentAlignment = "Center" FontWeight = "Bold" />
                    </StackPanel>


                    <CheckBox Grid.Column = "1" IsChecked = "{Binding IsLogarithmic}" Content = "Log Scale"
                              HorizontalAlignment = "Right" VerticalAlignment = "Center">
                        <CheckBox.Style>
                            <Style TargetType = "CheckBox" BasedOn = "{StaticResource {x:Type CheckBox}}">
                                <Style.Triggers>
                                    <DataTrigger Binding = "{Binding AutoDetectLogScale}" Value = "True">
                                        <Setter Property = "ToolTip">
                                            <Setter.Value>
                                                Scale is currently managed automatically based on data distribution.
                                                This can be changed in the UI Settings.
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </CheckBox.Style>
                    </CheckBox>
                </Grid>
            </Grid>

            <!-- Rows -->
            <ItemsControl Grid.Row = "2" ItemsSource = "{Binding Items}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin = "0,6">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width = "30" />  <!-- Lock Icon -->
                                <ColumnDefinition Width = "45" />  <!-- Percentage -->
                                <ColumnDefinition Width = "*" />   <!-- Slider -->
                                <ColumnDefinition Width = "120" />  <!-- Int Box -->
                            </Grid.ColumnDefinitions>

                            <!-- 1. Lock Button -->
                            <ToggleButton Grid.Column = "0" Style = "{StaticResource LockToggleStyle}"
                                          IsChecked = "{Binding IsLocked}" ToolTip = "Lock this value" />

                            <!-- 2. Percentage -->
                            <TextBlock Grid.Column = "1" Text = "{Binding PercentageDisplay}"
                                       VerticalAlignment = "Center" Foreground = "#888" FontSize = "11"
                                       Margin = "5,0,0,0" />

                            <!-- 3. Slider -->
                            <!-- IsEnabled bound to IsNotLocked -->
                            <Grid Grid.Column = "2" Margin = "10,0,10,0" x:Name = "SliderContainer">

                                <Slider Minimum = "0"
                                        Maximum = "{Binding DataContext.TotalLimit, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        Value = "{Binding SliderValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        IsEnabled = "{Binding IsNotLocked}" VerticalAlignment = "Center"
                                        TickFrequency = "1" IsSnapToTickEnabled = "False"
                                        Foreground = "{Binding ColorBrush}"
                                        local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />


                                <Rectangle HorizontalAlignment = "Left" Fill = "Red" Height = "4"
                                           VerticalAlignment = "Center" IsHitTestVisible = "False">
                                    <Rectangle.Width>
                                        <MultiBinding Converter = "{StaticResource LimitToWidthConverter}">
                                            <Binding Path = "SliderMinPosition" />
                                            <Binding Path = "DataContext.TotalLimit"
                                                     RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                            <!-- This works now because we named the Grid -->
                                            <Binding ElementName = "SliderContainer" Path = "ActualWidth" />
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>

                                <Rectangle HorizontalAlignment = "Right" Fill = "Red" Height = "4"
                                           VerticalAlignment = "Center" IsHitTestVisible = "False">
                                    <Rectangle.Width>
                                        <MultiBinding Converter = "{StaticResource LimitToWidthConverter}">
                                            <!-- Bind to the REMAINING space -->
                                            <Binding Path = "SliderMaxRemaining" />
                                            <Binding Path = "DataContext.TotalLimit"
                                                     RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                            <Binding ElementName = "SliderContainer" Path = "ActualWidth" />
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>

                                <TextBlock Text = "{Binding Name}" IsHitTestVisible = "False" VerticalAlignment = "Top"
                                           Margin = "2,-14,0,0" FontSize = "10" FontWeight = "Bold" Foreground = "#444" />
                            </Grid>

                            <StackPanel Grid.Column = "3" Orientation = "Horizontal">
                                <!-- Decrement -->
                                <styleClasses:BaseButton Content = "-" Command = "{Binding DecrementCommand}"
                                                         Style = "{StaticResource ThinBaseButtonStyle}"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />

                                <!-- TextBox -->
                                <styleClasses:CorneredTextBox Text = "{Binding Value, UpdateSourceTrigger=Explicit}"
                                                              local:TextBoxUtilities.UpdateDelay = "600"
                                                              VerticalContentAlignment = "Center"
                                                              HorizontalContentAlignment = "Center" Height = "24"
                                                              Width = "50" Margin = "2,0"
                                                              local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                    <styleClasses:CorneredTextBox.Style>
                                        <Style TargetType = "styleClasses:CorneredTextBox"
                                               BasedOn = "{StaticResource {x:Type styleClasses:CorneredTextBox}}">

                                            <Style.Triggers>
                                                <DataTrigger Binding = "{Binding IsLocked}" Value = "True">
                                                    <Setter Property = "FontWeight" Value = "Bold" />
                                                    <Setter Property = "Foreground" Value = "#D9534F" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </styleClasses:CorneredTextBox.Style>
                                </styleClasses:CorneredTextBox>

                                <!-- Increment -->
                                <styleClasses:BaseButton Content = "+" Command = "{Binding IncrementCommand}"
                                                         Style = "{StaticResource ThinBaseButtonStyle}"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />

                                <ToggleButton x:Name = "SettingsBtn" Content = "⚙" Width = "24" Height = "24"
                                              Style = "{StaticResource BlueToggleButtonStyle}" Margin = "2,0,0,0" />

                                <Popup IsOpen = "{Binding IsChecked, ElementName=SettingsBtn}" StaysOpen = "False"
                                       Placement = "Bottom" AllowsTransparency = "True">
                                    <Border BorderThickness = "2" Padding = "10" CornerRadius = "4"
                                            Background = "{StaticResource DefaultBackColorBrush}"
                                            BorderBrush = "{StaticResource DefaultBorderColorBrush}">
                                        <StackPanel>
                                            <TextBlock Text = "Constraints" FontWeight = "Bold" Margin = "0,0,0,5" />

                                            <Grid Margin = "0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width = "40" />
                                                    <ColumnDefinition Width = "60" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text = "Min:" VerticalAlignment = "Center" />

                                                <!-- UPDATED: Explicit Trigger + Helper -->
                                                <styleClasses:CorneredTextBox Grid.Column = "1"
                                                                              Text = "{Binding MinLimit, UpdateSourceTrigger=Explicit}"
                                                                              local:TextBoxUtilities.UpdateDelay = "300"
                                                                              local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </Grid>

                                            <Grid Margin = "0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width = "40" />
                                                    <ColumnDefinition Width = "60" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text = "Max:" VerticalAlignment = "Center" />

                                                <!-- UPDATED: Explicit Trigger + Helper -->
                                                <styleClasses:CorneredTextBox Grid.Column = "1"
                                                                              Text = "{Binding MaxLimit, UpdateSourceTrigger=Explicit}"
                                                                              local:TextBoxUtilities.UpdateDelay = "300"
                                                                              local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </Border>
</UserControl>