<UserControl x:Class = "Arcanum.UI.Components.UserControls.ValueAllocators.IntValueAllocator"
             xmlns = "http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x = "http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc = "http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d = "http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local = "clr-namespace:Arcanum.UI.Components.UserControls.ValueAllocators"
             xmlns:converters = "clr-namespace:Arcanum.UI.Components.Converters"
             xmlns:styleClasses = "clr-namespace:Arcanum.UI.Components.StyleClasses" mc:Ignorable = "d"
             d:DesignHeight = "300" d:DesignWidth = "300" d:DataContext = "{d:DesignInstance local:AllocatorViewModel}">

    <UserControl.InputBindings>
        <!-- Alt+Z Undo -->
        <KeyBinding Modifiers = "Alt" Key = "Z" Command = "{Binding UndoCommand}" />
    </UserControl.InputBindings>

    <UserControl.Resources>
        <!-- Style for the Lock Button -->
        <Style x:Key = "LockToggleStyle" TargetType = "ToggleButton">
            <Setter Property = "Template">
                <Setter.Value>
                    <ControlTemplate TargetType = "ToggleButton">
                        <Border Background = "Transparent" Padding = "2">
                            <ContentPresenter HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property = "Foreground" Value = "#AAA" />
            <Setter Property = "Content" Value = "🔓" /> <!-- Unlocked Icon -->
            <Setter Property = "Cursor" Value = "Hand" />
            <Style.Triggers>
                <Trigger Property = "IsChecked" Value = "True">
                    <Setter Property = "Content" Value = "🔒" /> <!-- Locked Icon -->
                    <Setter Property = "Foreground" Value = "#D9534F" /> <!-- Red when locked -->
                </Trigger>
                <Trigger Property = "IsMouseOver" Value = "True">
                    <Setter Property = "Foreground" Value = "#555" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key = "FineTuneButtonStyle" TargetType = "styleClasses:BaseButton">
            <Setter Property = "Width" Value = "20" />
            <Setter Property = "Height" Value = "24" />
            <Setter Property = "Background" Value = "Transparent" />
            <Setter Property = "BorderThickness" Value = "0" />
            <Setter Property = "FontWeight" Value = "Bold" />
            <Setter Property = "Foreground" Value = "#777" />
            <Setter Property = "Cursor" Value = "Hand" />
            <Setter Property = "Template">
                <Setter.Value>
                    <ControlTemplate TargetType = "Button">
                        <Border Background = "{TemplateBinding Background}" CornerRadius = "3">
                            <ContentPresenter HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property = "IsMouseOver" Value = "True">
                                <Setter Property = "Background" Value = "#EEE" />
                                <Setter Property = "Foreground" Value = "#000" />
                            </Trigger>
                            <Trigger Property = "IsPressed" Value = "True">
                                <Setter Property = "Background" Value = "#DDD" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Converter to calculate width based on distribution -->
        <converters:DistributionToWidthConverter x:Key = "DistributionToWidthConverter" />
        <converters:LimitToWidthConverter x:Key = "LimitToWidthConverter" />
    </UserControl.Resources>

    <Border BorderBrush = "#DDD" BorderThickness = "1" CornerRadius = "4" Padding = "10">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height = "20" />
                <RowDefinition Height = "Auto" />
                <RowDefinition Height = "*" />
            </Grid.RowDefinitions>

            <ItemsControl Grid.Row = "0" x:Name = "CompositionBar" ItemsSource = "{Binding Items}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation = "Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Height = "20" Background = "{Binding ColorBrush}" ToolTip = "{Binding Name}">
                            <Border.Width>
                                <MultiBinding Converter = "{StaticResource DistributionToWidthConverter}">
                                    <Binding Path = "Value" />
                                    <Binding Path = "DataContext.TotalLimit"
                                             RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                    <!-- Bind to the Container's Width -->
                                    <Binding ElementName = "CompositionBar" Path = "ActualWidth" />
                                </MultiBinding>
                            </Border.Width>

                            <!-- Optional: Show Number inside bar if wide enough -->
                            <TextBlock Text = "{Binding Value}" Foreground = "White" FontSize = "10"
                                       FontWeight = "Bold" HorizontalAlignment = "Center" VerticalAlignment = "Center">
                                <TextBlock.Style>
                                    <Style TargetType = "TextBlock">
                                        <Setter Property = "Visibility" Value = "Visible" />
                                        <Style.Triggers>
                                            <!-- Hide text if value is 0 -->
                                            <DataTrigger Binding = "{Binding Value}" Value = "0">
                                                <Setter Property = "Visibility" Value = "Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Header -->
            <Grid Grid.Row = "1" Margin = "0,0,0,15">
                <!-- Define columns to align Master Lock with Row Locks -->
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width = "30" /> <!-- Lock Column -->
                    <ColumnDefinition Width = "*" />
                </Grid.ColumnDefinitions>

                <!-- MASTER LOCK TOGGLE -->
                <ToggleButton Grid.Column = "0" Style = "{StaticResource LockToggleStyle}"
                              IsChecked = "{Binding AreAllLocked}" ToolTip = "Lock/Unlock All" />

                <!-- Total and Settings -->
                <Grid Grid.Column = "1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width = "Auto" />
                        <ColumnDefinition Width = "*" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column = "0" Orientation = "Horizontal" VerticalAlignment = "Center">
                        <TextBlock Text = "Total Limit:" FontWeight = "SemiBold" VerticalAlignment = "Center"
                                   Margin = "5,0,10,0" local:InteractionMonitor.AllocatorVM = "{Binding}" />
                        <TextBox Text = "{Binding TotalLimit, UpdateSourceTrigger=Explicit}"
                                 local:TextBoxUtilities.UpdateDelay = "600" Width = "60" Height = "24"
                                 VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center"
                                 FontWeight = "Bold" />
                    </StackPanel>

                    <CheckBox Grid.Column = "1" IsChecked = "{Binding IsLogarithmic}" Content = "Log Scale"
                              HorizontalAlignment = "Right" VerticalAlignment = "Center" />
                </Grid>
            </Grid>

            <!-- Rows -->
            <ItemsControl Grid.Row = "2" ItemsSource = "{Binding Items}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin = "0,6">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width = "30" />  <!-- Lock Icon -->
                                <ColumnDefinition Width = "45" />  <!-- Percentage -->
                                <ColumnDefinition Width = "*" />   <!-- Slider -->
                                <ColumnDefinition Width = "140" />  <!-- Int Box -->
                            </Grid.ColumnDefinitions>

                            <!-- 1. Lock Button -->
                            <ToggleButton Grid.Column = "0" Style = "{StaticResource LockToggleStyle}"
                                          IsChecked = "{Binding IsLocked}" ToolTip = "Lock this value" />

                            <!-- 2. Percentage -->
                            <TextBlock Grid.Column = "1" Text = "{Binding PercentageDisplay}"
                                       VerticalAlignment = "Center" Foreground = "#888" FontSize = "11"
                                       Margin = "5,0,0,0" />

                            <!-- 3. Slider -->
                            <!-- IsEnabled bound to IsNotLocked -->
                            <Grid Grid.Column = "2" Margin = "10,0,10,0" x:Name = "SliderContainer">

                                <Slider Minimum = "0"
                                        Maximum = "{Binding DataContext.TotalLimit, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        Value = "{Binding SliderValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        IsEnabled = "{Binding IsNotLocked}" VerticalAlignment = "Center"
                                        TickFrequency = "1" IsSnapToTickEnabled = "False"
                                        Foreground = "{Binding ColorBrush}"
                                        local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />


                                <Rectangle HorizontalAlignment = "Left" Fill = "Red" Height = "4"
                                           VerticalAlignment = "Center" IsHitTestVisible = "False">
                                    <Rectangle.Width>
                                        <MultiBinding Converter = "{StaticResource LimitToWidthConverter}">
                                            <Binding Path = "SliderMinPosition" />
                                            <Binding Path = "DataContext.TotalLimit"
                                                     RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                            <!-- This works now because we named the Grid -->
                                            <Binding ElementName = "SliderContainer" Path = "ActualWidth" />
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>

                                <Rectangle HorizontalAlignment = "Right" Fill = "Red" Height = "4"
                                           VerticalAlignment = "Center" IsHitTestVisible = "False">
                                    <Rectangle.Width>
                                        <MultiBinding Converter = "{StaticResource LimitToWidthConverter}">
                                            <!-- Bind to the REMAINING space -->
                                            <Binding Path = "SliderMaxRemaining" />
                                            <Binding Path = "DataContext.TotalLimit"
                                                     RelativeSource = "{RelativeSource AncestorType=UserControl}" />
                                            <Binding ElementName = "SliderContainer" Path = "ActualWidth" />
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>

                                <TextBlock Text = "{Binding Name}" IsHitTestVisible = "False" VerticalAlignment = "Top"
                                           Margin = "2,-14,0,0" FontSize = "10" FontWeight = "Bold" Foreground = "#444" />
                            </Grid>

                            <StackPanel Grid.Column = "3" Orientation = "Horizontal">
                                <!-- Decrement -->
                                <styleClasses:BaseButton Content = "-" Command = "{Binding DecrementCommand}"
                                                         Style = "{StaticResource FineTuneButtonStyle}"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />

                                <!-- TextBox -->
                                <TextBox Text = "{Binding Value, UpdateSourceTrigger=Explicit}"
                                         local:TextBoxUtilities.UpdateDelay = "600" VerticalContentAlignment = "Center"
                                         HorizontalContentAlignment = "Center" Height = "24" Width = "60"
                                         Margin = "2,0"
                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                    <TextBox.Style>
                                        <Style TargetType = "TextBox">
                                            <Style.Triggers>
                                                <DataTrigger Binding = "{Binding IsLocked}" Value = "True">
                                                    <Setter Property = "FontWeight" Value = "Bold" />
                                                    <Setter Property = "Foreground" Value = "#D9534F" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>

                                <!-- Increment -->
                                <styleClasses:BaseButton Content = "+" Command = "{Binding IncrementCommand}"
                                                         Style = "{StaticResource FineTuneButtonStyle}"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                <ToggleButton x:Name = "SettingsBtn" Content = "⚙" Width = "20" Height = "24"
                                              Foreground = "#AAA" Margin = "0,0,2,0" />

                                <Popup IsOpen = "{Binding IsChecked, ElementName=SettingsBtn}" StaysOpen = "False"
                                       Placement = "Bottom">
                                    <Border Background = "White" BorderBrush = "#CCC" BorderThickness = "1"
                                            Padding = "10" CornerRadius = "4">
                                        <StackPanel>
                                            <TextBlock Text = "Constraints" FontWeight = "Bold" Margin = "0,0,0,5" />

                                            <Grid Margin = "0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width = "40" />
                                                    <ColumnDefinition Width = "60" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text = "Min:" VerticalAlignment = "Center" />

                                                <!-- UPDATED: Explicit Trigger + Helper -->
                                                <TextBox Grid.Column = "1"
                                                         Text = "{Binding MinLimit, UpdateSourceTrigger=Explicit}"
                                                         local:TextBoxUtilities.UpdateDelay = "300"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </Grid>

                                            <Grid Margin = "0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width = "40" />
                                                    <ColumnDefinition Width = "60" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text = "Max:" VerticalAlignment = "Center" />

                                                <!-- UPDATED: Explicit Trigger + Helper -->
                                                <TextBox Grid.Column = "1"
                                                         Text = "{Binding MaxLimit, UpdateSourceTrigger=Explicit}"
                                                         local:TextBoxUtilities.UpdateDelay = "300"
                                                         local:InteractionMonitor.AllocatorVM = "{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </Border>
</UserControl>